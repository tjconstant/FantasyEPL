---
title: "Fantasy Football 2017/18"
author: "Tom Constant"
output: 
  html_document: 
    self_contained: no
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

# Current Ratings {.tabset} 
Updated `r Sys.time()`

## Physics Fantasy Football  

```{r warning = FALSE, echo =  FALSE, message=FALSE}
library(jsonlite)
library(ggplot2)
library(plotly)
theme_set(theme_bw())
```


```{r echo = FALSE}
players <- c(378067,2938617,1309360,386429,376149) # Tom C, Tom G, Ben, Ian, Gareth
```

```{r scrape, echo = FALSE}
scrape <- function(players){
  
  all <- data.frame()
  
  for(id in players){
    
    history <- read_json(paste0("https://fantasy.premierleague.com/drf/entry/",id,"/history"), simplifyVector = T)
    
    team_info <- data.frame(as.list(unlist(history[['entry']])))
    team_info <- team_info[,!names(team_info) %in% "kit"] # not everyone designs a kit
    team_info <- team_info[,!names(team_info) %in% "favourite_team"] # not everyone sets a fav team
    
    all <- rbind(all,
                 data.frame(team_info, 
                            manager = paste(team_info$player_first_name, team_info$player_last_name), 
                            history[['history']])
    )
  }
  
  rank <- function(x){
    position <- numeric(length(unique(x$id)))
    position[(order(-x$total_points))] <- 1:(length(unique(x$id)))
    return(position)
  }
  
  temp <- data.frame()
  for(i in 1:length(unique(all$event))){
    temp <- rbind(temp, rank(subset(all, event == i)))
  }
  temp <- unlist(temp)
  all <- cbind(all, league_rank = temp)
  
  # reorder factors for current leader
  all$manager <- factor(all$manager, levels = unique(all$manager)[order(all$league_rank[all$event == max(all$event)])])
  all$name <- factor(all$name, levels = unique(all$name)[order(all$league_rank[all$event == max(all$event)])])
  
  dates <- c()
date <- read_json(paste0("https://fantasy.premierleague.com/drf/fixtures/", 1), simplifyVector = T)

for(i in 1:(max(all$event))){
  dates <- cbind(dates, subset(date, event == i & event_day == 1)[1,]$kickoff_time)
}

all <- data.frame(all, gw_date = rep(as.Date(dates), length(unique(all$id))))
  
  return(all)
}

all <- scrape(players)

### Add Dates 


```

### Table: Physics Fantasy Football 

```{r table, echo = FALSE, results='html'}
tb <- subset(all, event == max(all$event))

tb <- tb[order(-tb$total_points),]

knitr::kable(data.frame(
  pos = 1:length(unique(tb$manager)),manager = tb$manager,team = tb$name, `gameweek points` = tb$points, `total points` = tb$total_points
)
)

#, mv = "\U25B2"
```

### Plots: Physics Fantasy Football {.tabset .tabset-fade .tabset-pills}

####  Cumulative Score

```{r cumscore}
ggplot(all, aes(gw_date, total_points, colour = name, group = name))  + geom_point() + geom_line() + xlab("Gameweek Date") + ylab("Total Points")
```

#### Linear Regression 

```{r linreg}
ggplot(all, aes(event, total_points, colour = name, fill = name, group = name))  + geom_point() + geom_smooth(method = "lm", fullrange = TRUE, se = T, alpha = 0.2, formula = y ~ x + 0) + xlim(NA,38) + xlab("Gameweek") + ylab("Total Points")#+ xlim(as.Date("2017-08-11"), as.Date("2018-05-13")) 
```

#### Linear Regression: Recent Form (Last 5 GW)

```{r linreg2}
ggplot(all, aes(event, total_points, colour = name, group = name))  + geom_point() + geom_smooth(data = subset(all, event >= (max(event)-5)), method = "lm", fullrange = TRUE, se = F)  +xlim(NA, 38) + xlab("Gameweek") + ylab("Total Points")#+ xlim(as.Date("2017-08-11"), as.Date("2018-05-13"))
```

#### Relative Performance Index

```{r rpi, message=FALSE, warning = FALSE,error=FALSE, fig.width =9}
library(dplyr)
mean_data <- group_by(all, event) %>%
  summarise(points = mean(points, na.rm = TRUE))

p<-ggplot(data.frame(all, mean_gw = all$points-rep(mean_data$points, length(unique(all$name)))), aes(event, mean_gw, fill = manager, colour = manager)) + 
  geom_bar(stat = "identity", position = "identity", alpha = 0.5) + scale_x_continuous(breaks=1:(max(all$event))) + xlab("Gameweek") + ylab("Relative Performance Index") + theme(legend.title = element_blank())

ggplotly(p, tooltip = "") %>% config(displayModeBar = FALSE)  %>% layout(xaxis=list(fixedrange=TRUE)) %>% layout(yaxis=list(fixedrange=TRUE))
```

```{r si, fig.height=1.5}
rpi.df <- data.frame(manager = all$manager,
           rpi = all$points-rep(mean_data$points, length(unique(all$name))))
rpi.df <-               
rpi.df %>% 
  group_by(manager) %>% 
  count(si = rpi >= 0 & rpi != 0) %>%
  mutate(sindex=n[si==T]-n[si==F]) %>%
  mutate(label = sindex)

ggplot(rpi.df, aes(x=manager, y=1, fill = sindex, colour = sindex)) + 
  geom_point(size = 25) + 
  geom_text(aes(label = label), colour = 1) +
  theme_minimal() + 
  theme(legend.position = "none",line = element_blank(),
        axis.line = element_blank(),
        axis.text.y = element_blank(),
        axis.title = element_blank()
  ) + 
  scale_fill_gradientn(colours = c('red2', 'transparent', 'chartreuse3')) + 
  scale_colour_gradientn(colours = c('red2', 'transparent', 'chartreuse3')) + ggtitle("Realative Skill Index")

```

#### Gain Loss Matrix

```{r glm, warning=FALSE, fig.asp=1}
gw <- subset(all, event == max(all$event))

N <- length(gw$points)

gal <- array(gw$points, dim = c(N,N)) - t(array(gw$points, dim = c(N,N)))
dim(gal) <- c(N*N,1)

gal.labels <- as.character(gal)
gal.labels[gal > 0] <- paste0("+",gal.labels[gal > 0])
gal.labels[gal == 0] <- ""

gal.df <- data.frame(x = gw$manager, y = rep(gw$manager, each = N), gal)
levels(gal.df$y) <- paste("vs.", levels(gal.df$y))

ggplot(gal.df, aes(x, y, fill = gal, label = gal.labels)) + 
  geom_raster(alpha = 0.5) + geom_point(aes(colour = gal), size = 25) +
  geom_text() + 
  scale_fill_gradientn(colours = c('red', 'transparent', 'chartreuse3')) + 
  scale_colour_gradientn(colours = c('red', 'transparent', 'chartreuse3')) + 
  scale_x_discrete(position = "top") +
  scale_y_discrete(position="right") +
  theme(legend.position = "none") +
  xlab("") + ylab("") + coord_cartesian(expand = c(0,0)) + 
  ggtitle(paste("Gameweek", max(all$event))) + coord_fixed(expand = c(0,0))
```

#### Team Value

```{r value}
ggplot(all, aes(gw_date, value.1/10, colour = name, fill = name, group = name))  + geom_point() + geom_smooth(alpha = 0.2) + xlab("Gameweek Date") + ylab("Team Value (Â£ million)")
```

#### Point Distribution By Manager

```{r dist, warning = FALSE, fig.height=3}
ggplot(all, aes(points, fill = manager, group = manager))  + geom_density() + facet_wrap(~manager, ncol = 3) + coord_cartesian(expand = c(0,0)) + xlim(0,NA) + xlab("Gameweek Points")
```

Based on these probability distributions, and simulating 1000 different season outcomes for the remaining gameweeks, the percentage of seasons won by the players is as follows:

```{r sim, echo = F, fig.height=2}
season_model <- data.frame()
N <- 1000

#pb <- txtProgressBar(min = 0, max = N, initial = 0)

for(m in unique(all$manager)){
  a <- subset(all, manager == m)
  pdf_of_data <- density(a$points)
  
  for(n in 1:N){
    random.points <- approx(
      cumsum(pdf_of_data$y)/sum(pdf_of_data$y),
      pdf_of_data$x,
      runif(38-max(a$event))
    )$y
    
    season_model <- rbind(season_model,data.frame(itr = n , manager = m, final_score=(max(a$total_points) + sum(random.points))))
    #setTxtProgressBar(pb, n)
  }
}

result <-
  season_model %>% 
  group_by(itr) %>% 
  slice(which.max(final_score)) %>% 
  group_by(manager) %>% 
  summarise(n = n(), mean = mean(final_score), pct = round(100*n()/N,2), label = paste0(round(100*n()/N,2), "%"))
if(any(!(unique(all$manager) %in% result$manager))){
result <- rbind(
  result,
  data.frame(
    manager = unique(all$manager)[!(unique(all$manager) %in% result$manager)],
    n = 0,
    mean = NA,
    pct = 0,
    label = "0%"
    ))
}

result$manager <- factor(result$manager, levels = result$manager[order(-result$pct)])

ggplot(result, aes(x=manager, y=1, fill = pct, colour = pct)) + 
  geom_point(size = 25) + 
  geom_text(aes(label = label), colour = 1) +
  theme_minimal() + 
  theme(legend.position = "none",line = element_blank(),
        axis.line = element_blank(),
        axis.text.y = element_blank(),
        axis.title = element_blank()
        ) + 
  scale_fill_gradientn(colours = c('red2', 'transparent', 'chartreuse3')) + 
  scale_colour_gradientn(colours = c('red2', 'transparent', 'chartreuse3'))
```

#### Mini League Positions

```{r league, fig.height=6}
ggplot(all, aes(gw_date, league_rank, colour = name)) + geom_step(lwd = 1.25)+ geom_point(size = 3) + facet_grid(manager ~ .)  + scale_y_continuous(breaks = 1:(length(unique(all$id))), trans = "reverse") + theme(panel.grid.minor = element_line(linetype = 0)) + xlab("Gameweek Date") + ylab("League Position")
```

```{r echo = FALSE}
source("generate_feed.R")
```

## UoE Premiership

```{r echo = FALSE}
players <- c(386429, 1324461, 378067, 843758, 373089, 2268116, 656073, 1878698, 3605945) 

all <- scrape(players)
```

### Table: UoE Premiership

```{r echo = FALSE}
<<table>>
```

### Plots: UoE Premiership {.tabset .tabset-fade .tabset-pills}

####  Cumulative Score

```{r}
<<cumscore>>
```

#### Linear Regression 

```{r}
<<linreg>>
```

#### Linear Regression: Recent Form (Last 5 GW)

```{r}
<<linreg2>>
```

#### Relative Performance Index

```{r message=FALSE, warning = FALSE,error=FALSE, fig.width =9}
<<rpi>>
```

```{r, fig.height=1.5}
<<si>>
```

#### Gain Loss Matrix

```{r warning=FALSE, fig.asp = 1, fig.width=10}
<<glm>>
```

#### Team Value

```{r}
<<value>>
```

#### Point Distribution By Manager

```{r fig.height = 6, warning = FALSE}
<<dist>>
```

Based on these probability distributions, and simulating 1000 different season outcomes for the remaining gameweeks, the percentage of seasons won by the players is as follows:

```{r echo = F, fig.height=2, fig.width=9}
<<sim>>
```

#### Mini League Positions

```{r fig.height = 10}
<<league>>
```